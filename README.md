# Sistema de Préstamo de Libros - Biblioteca Virtual

<p align="center"><a href="https://laravel.com" target="_blank"><img src="https://raw.githubusercontent.com/laravel/art/master/logo-lockup/5%20SVG/2%20CMYK/1%20Full%20Color/laravel-logolockup-cmyk-red.svg" width="400" alt="Laravel Logo"></a></p>

<p align="center">
<a href="https://github.com/laravel/framework/actions"><img src="https://github.com/laravel/framework/workflows/tests/badge.svg" alt="Build Status"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/dt/laravel/framework" alt="Total Downloads"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/v/laravel/framework" alt="Latest Stable Version"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/l/laravel/framework" alt="License"></a>
</p>

# Descripción

Sistema web para la gestión y préstamo de libros en una biblioteca virtual, desarrollado con Laravel y Oracle Database. Incluye autenticación por roles, gestión de usuarios, libros, autores y categorías, y lógica de negocio implementada tanto en Laravel como en la base de datos mediante PL/SQL (procedimientos almacenados, triggers y paquetes).

## Características principales

- Autenticación de usuarios con roles (Administrador/Bibliotecario y Usuario).
- CRUD de usuarios (solo para administrador).
- CRUD de libros (solo para administrador, usuarios solo pueden ver).
- CRUD de autores y categorías (solo para administrador).
- Control de acceso seguro: los usuarios normales no pueden acceder a rutas ni vistas de administración.
- Interfaz moderna con Bootstrap 5.

## Requisitos para la conexión a la base de datos y compatibilidad

- Tener instalado **XAMPP** (para entorno local con Apache y PHP).
- Tener instalado Oracle Database (o acceso a una instancia de Oracle).
- **PHP 8.1** o superior (incluido en XAMPP o instalar manualmente).
- Instalar la extensión **oci8** para PHP (requerida para compatibilidad de Laravel con Oracle). Puedes instalarla siguiendo la documentación oficial de PHP o usando PECL:
  - `pecl install oci8`
  - O descarga el DLL correspondiente y actívalo en tu `php.ini`.
- Instalar el paquete `yajra/laravel-oci8` mediante Composer para la integración de Laravel con Oracle:
  - `composer require yajra/laravel-oci8`
- Instalar Composer y Node.js.
- Configurar correctamente las variables de entorno en `.env`:
  - `DB_CONNECTION=oracle`
  - `DB_HOST=...`
  - `DB_PORT=1521`
  - `DB_DATABASE=...`
  - `DB_USERNAME=...`
  - `DB_PASSWORD=...`
  - `DB_SERVICE_NAME=...`

## Script completo para Oracle: Creación y limpieza de objetos de la base de datos

> **Nota:** Antes de crear las tablas, procedimientos, funciones y triggers, se recomienda ejecutar los siguientes bloques para eliminar cualquier objeto existente con los mismos nombres y evitar conflictos.

```sql
-- =============================
-- SCRIPT COMPLETO BIBLIOTECA ORACLE (DROP OBJETOS SI EXISTEN)
-- =============================

-- 0. ELIMINAR OBJETOS EXISTENTES (TRIGGERS, PROCEDIMIENTOS, FUNCIONES, TABLAS)

-- Eliminar trigger
BEGIN
    FOR rec IN (SELECT trigger_name FROM user_triggers WHERE trigger_name = 'TRG_UPDATE_LIBRO_MODIFICACION') LOOP
        EXECUTE IMMEDIATE 'DROP TRIGGER ' || rec.trigger_name;
    END LOOP;
END;
/

-- Eliminar procedimientos y funciones
BEGIN
    FOR rec IN (
        SELECT object_name, object_type FROM user_objects
        WHERE (object_type = 'PROCEDURE' AND object_name IN (
            'CREAR_AUTOR', 'ACTUALIZAR_AUTOR', 'ELIMINAR_AUTOR',
            'CREAR_CATEGORIA', 'ACTUALIZAR_CATEGORIA', 'ELIMINAR_CATEGORIA',
            'CREAR_LIBRO', 'ACTUALIZAR_LIBRO', 'ELIMINAR_LIBRO',
            'REGISTRAR_USUARIO'
        )) OR (object_type = 'FUNCTION' AND object_name = 'AUTENTICAR_USUARIO')
    ) LOOP
        EXECUTE IMMEDIATE 'DROP ' || rec.object_type || ' ' || rec.object_name;
    END LOOP;
END;
/

-- Eliminar tablas (en orden de dependencias)
BEGIN
    FOR rec IN (SELECT table_name FROM user_tables WHERE table_name IN ('LIBROS', 'CATEGORIAS', 'AUTORES', 'USUARIOS', 'ROLES')) LOOP
        EXECUTE IMMEDIATE 'DROP TABLE ' || rec.table_name || ' CASCADE CONSTRAINTS';
    END LOOP;
END;
/

-- =============================
-- SCRIPT COMPLETO BIBLIOTECA ORACLE
-- =============================

-- 1. CREACIÓN DE TABLAS

CREATE TABLE roles (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre VARCHAR2(50) NOT NULL UNIQUE
);

CREATE TABLE usuarios (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre VARCHAR2(100) NOT NULL,
    email VARCHAR2(100) NOT NULL UNIQUE,
    password VARCHAR2(255) NOT NULL,
    rol_id NUMBER NOT NULL,
    fecha_registro DATE DEFAULT SYSDATE,
    CONSTRAINT fk_rol FOREIGN KEY (rol_id) REFERENCES roles(id)
);

CREATE TABLE autores (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre VARCHAR2(100) NOT NULL
);

CREATE TABLE categorias (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre VARCHAR2(100) NOT NULL
);

CREATE TABLE libros (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    titulo VARCHAR2(200) NOT NULL,
    autor_id NUMBER NOT NULL,
    categoria_id NUMBER NOT NULL,
    anio_publicacion NUMBER,
    fecha_creacion DATE DEFAULT SYSDATE,
    fecha_modificacion DATE,
    CONSTRAINT fk_autor FOREIGN KEY (autor_id) REFERENCES autores(id),
    CONSTRAINT fk_categoria FOREIGN KEY (categoria_id) REFERENCES categorias(id)
);

-- 2. ROLES PREDEFINIDOS
INSERT INTO roles (nombre) VALUES ('Bibliotecario');
INSERT INTO roles (nombre) VALUES ('Usuario');

-- 3. TRIGGERS DE AUDITORÍA

-- Actualiza fecha_modificacion al modificar un libro
CREATE OR REPLACE TRIGGER trg_update_libro_modificacion
BEFORE UPDATE ON libros
FOR EACH ROW
BEGIN
    :NEW.fecha_modificacion := SYSDATE;
END;
/

-- 4. PROCEDIMIENTOS ALMACENADOS Y FUNCIONES

-- Registro de usuario
CREATE OR REPLACE PROCEDURE registrar_usuario(
    p_nombre IN VARCHAR2,
    p_email IN VARCHAR2,
    p_password IN VARCHAR2,
    p_rol_nombre IN VARCHAR2,
    p_mensaje OUT VARCHAR2
) AS
    v_rol_id NUMBER;
BEGIN
    SELECT id INTO v_rol_id FROM roles WHERE nombre = p_rol_nombre;
    INSERT INTO usuarios (nombre, email, password, rol_id)
    VALUES (p_nombre, p_email, p_password, v_rol_id);
    p_mensaje := 'Usuario registrado correctamente.';
EXCEPTION
    WHEN OTHERS THEN
        p_mensaje := 'Error: ' || SQLERRM;
END;
/

-- Autenticación de usuario
CREATE OR REPLACE FUNCTION autenticar_usuario(
    p_email IN VARCHAR2,
    p_password IN VARCHAR2
) RETURN NUMBER AS
    v_user_id NUMBER;
BEGIN
    SELECT id INTO v_user_id FROM usuarios WHERE email = p_email AND password = p_password;
    RETURN v_user_id;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN NULL;
END;
/

-- CRUD AUTORES
CREATE OR REPLACE PROCEDURE crear_autor(p_nombre IN VARCHAR2, p_mensaje OUT VARCHAR2) AS
BEGIN
    INSERT INTO autores (nombre) VALUES (p_nombre);
    p_mensaje := 'Autor creado correctamente.';
EXCEPTION
    WHEN OTHERS THEN
        p_mensaje := 'Error: ' || SQLERRM;
END;
/

CREATE OR REPLACE PROCEDURE actualizar_autor(p_id IN NUMBER, p_nombre IN VARCHAR2, p_mensaje OUT VARCHAR2) AS
BEGIN
    UPDATE autores SET nombre = p_nombre WHERE id = p_id;
    p_mensaje := 'Autor actualizado correctamente.';
EXCEPTION
    WHEN OTHERS THEN
        p_mensaje := 'Error: ' || SQLERRM;
END;
/

CREATE OR REPLACE PROCEDURE eliminar_autor(p_id IN NUMBER, p_mensaje OUT VARCHAR2) AS
BEGIN
    DELETE FROM autores WHERE id = p_id;
    p_mensaje := 'Autor eliminado correctamente.';
EXCEPTION
    WHEN OTHERS THEN
        p_mensaje := 'Error: ' || SQLERRM;
END;
/

-- CRUD CATEGORÍAS
CREATE OR REPLACE PROCEDURE crear_categoria(p_nombre IN VARCHAR2, p_mensaje OUT VARCHAR2) AS
BEGIN
    INSERT INTO categorias (nombre) VALUES (p_nombre);
    p_mensaje := 'Categoría creada correctamente.';
EXCEPTION
    WHEN OTHERS THEN
        p_mensaje := 'Error: ' || SQLERRM;
END;
/

CREATE OR REPLACE PROCEDURE actualizar_categoria(p_id IN NUMBER, p_nombre IN VARCHAR2, p_mensaje OUT VARCHAR2) AS
BEGIN
    UPDATE categorias SET nombre = p_nombre WHERE id = p_id;
    p_mensaje := 'Categoría actualizada correctamente.';
EXCEPTION
    WHEN OTHERS THEN
        p_mensaje := 'Error: ' || SQLERRM;
END;
/

CREATE OR REPLACE PROCEDURE eliminar_categoria(p_id IN NUMBER, p_mensaje OUT VARCHAR2) AS
BEGIN
    DELETE FROM categorias WHERE id = p_id;
    p_mensaje := 'Categoría eliminada correctamente.';
EXCEPTION
    WHEN OTHERS THEN
        p_mensaje := 'Error: ' || SQLERRM;
END;
/

-- CRUD LIBROS
CREATE OR REPLACE PROCEDURE crear_libro(
    p_titulo IN VARCHAR2,
    p_autor_id IN NUMBER,
    p_categoria_id IN NUMBER,
    p_anio_publicacion IN NUMBER,
    p_mensaje OUT VARCHAR2
) AS
BEGIN
    INSERT INTO libros (titulo, autor_id, categoria_id, anio_publicacion)
    VALUES (p_titulo, p_autor_id, p_categoria_id, p_anio_publicacion);
    p_mensaje := 'Libro creado correctamente.';
EXCEPTION
    WHEN OTHERS THEN
        p_mensaje := 'Error: ' || SQLERRM;
END;
/

CREATE OR REPLACE PROCEDURE actualizar_libro(
    p_id IN NUMBER,
    p_titulo IN VARCHAR2,
    p_autor_id IN NUMBER,
    p_categoria_id IN NUMBER,
    p_anio_publicacion IN NUMBER,
    p_mensaje OUT VARCHAR2
) AS
BEGIN
    UPDATE libros SET titulo = p_titulo, autor_id = p_autor_id, categoria_id = p_categoria_id, anio_publicacion = p_anio_publicacion
    WHERE id = p_id;
    p_mensaje := 'Libro actualizado correctamente.';
EXCEPTION
    WHEN OTHERS THEN
        p_mensaje := 'Error: ' || SQLERRM;
END;
/

CREATE OR REPLACE PROCEDURE eliminar_libro(p_id IN NUMBER, p_mensaje OUT VARCHAR2) AS
BEGIN
    DELETE FROM libros WHERE id = p_id;
    p_mensaje := 'Libro eliminado correctamente.';
EXCEPTION
    WHEN OTHERS THEN
        p_mensaje := 'Error: ' || SQLERRM;
END;
/

-- 5. DATOS DE PRUEBA

INSERT INTO autores (nombre) VALUES ('Gabriel García Márquez');
INSERT INTO autores (nombre) VALUES ('Mario Vargas Llosa');
INSERT INTO autores (nombre) VALUES ('Isabel Allende');

INSERT INTO categorias (nombre) VALUES ('Novela');
INSERT INTO categorias (nombre) VALUES ('Cuento');
INSERT INTO categorias (nombre) VALUES ('Ensayo');

-- Inserta usuarios de ejemplo
INSERT INTO usuarios (nombre, email, password, rol_id) VALUES ('Admin', 'admin@biblioteca.com', 'admin123', 1);
INSERT INTO usuarios (nombre, email, password, rol_id) VALUES ('Juan Perez', 'juan@correo.com', 'juan123', 2);
INSERT INTO usuarios (nombre, email, password, rol_id) VALUES ('Maria Lopez', 'maria@correo.com', 'maria123', 2);

-- Inserta libros de ejemplo
INSERT INTO libros (titulo, autor_id, categoria_id, anio_publicacion) VALUES ('Cien años de soledad', 1, 1, 1967);
INSERT INTO libros (titulo, autor_id, categoria_id, anio_publicacion) VALUES ('La ciudad y los perros', 2, 1, 1963);
INSERT INTO libros (titulo, autor_id, categoria_id, anio_publicacion) VALUES ('La casa de los espíritus', 3, 1, 1982);

COMMIT;

-- =============================
-- FIN DE SCRIPT
-- =============================
```

## Pasos para ejecutar la aplicación

1. **Clona el repositorio**  
   `git clone <url-del-repo>`
2. **Instala dependencias**  
   `composer install`
3. **Configura el archivo `.env`**  
   Copia `.env.example` a `.env` y edita los datos de conexión a Oracle y otras variables necesarias.
4. **Genera la clave de la aplicación**  
   `php artisan key:generate`
5. **Ejecuta migraciones y seeders**  
   Si usas migraciones y seeders, ejecuta:  
   `php artisan migrate --seed`
6. **Inicia el servidor de desarrollo**  
   `php artisan serve`
7. **Accede a la aplicación**  
   Ve a [http://127.0.0.1:8000](http://127.0.0.1:8000) en tu navegador.

## Seguridad

- El menú y las rutas de administración solo están disponibles para el administrador.
- Los usuarios normales solo pueden ver libros y su propio perfil.
- Si un usuario intenta acceder a una URL restringida, recibirá un error 403.
- El enlace "Biblioteca" en el menú está deshabilitado para usuarios normales.

## Modelo de tablas de la base de datos

A continuación se muestran los modelos de las tablas principales con sus campos:

### Tabla: CATEGORIAS

| Campo         | Tipo             | Restricciones         |
|-------------- |------------------|----------------------|
| ID_CATEGORIA  | NUMBER           | PRIMARY KEY, AUTO INCREMENT |
| NOMBRE        | VARCHAR2(100)    | ÚNICO, NOT NULL      |

### Tabla: AUTORES

| Campo      | Tipo           | Restricciones         |
|------------|----------------|----------------------|
| ID_AUTOR   | NUMBER         | PRIMARY KEY, AUTO INCREMENT |
| NOMBRE     | VARCHAR2(100)  | NOT NULL             |

### Tabla: LIBROS

| Campo             | Tipo             | Restricciones         |
|-------------------|------------------|----------------------|
| ID_LIBRO          | NUMBER           | PRIMARY KEY, AUTO INCREMENT |
| TITULO            | VARCHAR2(200)    | NOT NULL             |
| DESCRIPCION       | VARCHAR2(500)    |                      |
| CATEGORIA_ID      | NUMBER           | FOREIGN KEY (CATEGORIAS) |
| AUTOR_ID          | NUMBER           | FOREIGN KEY (AUTORES) |
| FECHA_PUBLICACION | DATE             |                      |

### Tabla: USUARIOS

| Campo     | Tipo            | Restricciones         |
|-----------|-----------------|----------------------|
| ID_USUARIO| NUMBER          | PRIMARY KEY, AUTO INCREMENT |
| NOMBRE    | VARCHAR2(100)   | NOT NULL             |
| CORREO    | VARCHAR2(100)   | ÚNICO, NOT NULL      |
| PASSWORD  | VARCHAR2(255)   | NOT NULL             |
| ROL_ID    | NUMBER          |                      |

## Tecnologías utilizadas

<p align="left">
  <img src="https://raw.githubusercontent.com/laravel/art/master/logo-lockup/5%20SVG/2%20CMYK/1%20Full%20Color/laravel-logolockup-cmyk-red.svg" alt="Laravel" height="40">
  <img src="https://getbootstrap.com/docs/5.0/assets/brand/bootstrap-logo-shadow.png" alt="Bootstrap" height="40" style="margin-left:20px;">
  <img src="https://upload.wikimedia.org/wikipedia/commons/6/68/Oracle_SQL_Developer_logo.svg" alt="Oracle" height="40" style="margin-left:20px;">
  <img src="https://upload.wikimedia.org/wikipedia/commons/6/62/CSS3_logo.svg" alt="CSS3" height="40" style="margin-left:20px;">
  <img src="https://upload.wikimedia.org/wikipedia/commons/6/61/HTML5_logo_and_wordmark.svg" alt="HTML5" height="40" style="margin-left:20px;">
</p>

- **Backend y Frontend:** Laravel 10+
- **Base de Datos:** Oracle Database
- **Lógica en Base de Datos:** PL/SQL (procedimientos almacenados, triggers, paquetes)
- **Bootstrap 5**
- **CSS3**
- **HTML5**

Estas son las tecnologías principales empleadas en el desarrollo y funcionamiento del sistema.

---

Desarrollado por Jesús.
